"use client";

import { useState, useMemo, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { ApiResult, ApiScanJob } from "@/lib/api-data";
import { fetchApiJobs, fetchApiJob } from "./services/job-service";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { 
  CheckCircle, 
  Clock, 
  Download, 
  Eye, 
  Filter, 
  RefreshCw, 
  XCircle 
} from "@/components/ui/icons";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { format } from "date-fns";
import { Progress } from "@/components/ui/progress";

interface ScanResultsViewProps {
  jobId?: string;
  jobs?: ApiScanJob[];
  onSelectJob?: (jobId: string) => void;
}

export default function ScanResultsView({ jobId, jobs: initialJobs, onSelectJob }: ScanResultsViewProps): JSX.Element {
  const [jobs, setJobs] = useState<ApiScanJob[]>(initialJobs || []);
  const [loading, setLoading] = useState<boolean>(!initialJobs);
  const [selectedJobId, setSelectedJobId] = useState<string | undefined>(jobId);
  const [filter, setFilter] = useState<"all" | "success" | "failed" | "network-errors" | "test-passed" | "test-failed">("all");
  const [sortBy, setSortBy] = useState<"execution-order" | "response-time" | "status-code" | "test-results">("execution-order");
  const [sortDirection, setSortDirection] = useState<"asc" | "desc">("asc");
  const [isResultDialogOpen, setIsResultDialogOpen] = useState(false);
  const [selectedResult, setSelectedResult] = useState<ApiResult | null>(null);
  
  // Â¶ÇÊûúÊ≤°ÊúâÊèê‰æõÂàùÂßã‰Ωú‰∏öÊï∞ÊçÆÔºåÂàô‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
  useEffect(() => {
    if (!initialJobs) {
      const loadJobs = async () => {
        setLoading(true);
        try {
          const apiJobs = await fetchApiJobs();
          setJobs(apiJobs);
          
          // Â¶ÇÊûúÊúâjobId‰ΩÜÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰Ωï‰Ωú‰∏öÔºåËá™Âä®ÈÄâÊã©ËØ•‰Ωú‰∏ö
          if (jobId && !selectedJobId) {
            setSelectedJobId(jobId);
          } else if (!selectedJobId && apiJobs.length > 0 && apiJobs[0].id) {
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰Ωï‰Ωú‰∏ö‰∏îÊúâ‰Ωú‰∏öÊï∞ÊçÆÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™‰Ωú‰∏ö
            // Á°Æ‰øùidÂ≠òÂú®ÂÜçËÆæÁΩÆ
            setSelectedJobId(apiJobs[0].id);
            if (onSelectJob && apiJobs[0].id) onSelectJob(apiJobs[0].id);
          }
        } catch (error) {
          console.error('Âä†ËΩΩAPIÊµãËØï‰Ωú‰∏öÂ§±Ë¥•:', error);
        } finally {
          setLoading(false);
        }
      };
      
      loadJobs();
    }
  }, [initialJobs, jobId, selectedJobId, onSelectJob]);
  
  // Â§ÑÁêÜ‰Ωú‰∏öÈÄâÊã©ÂèòÊõ¥
  const handleSelectJob = (id: string) => {
    setSelectedJobId(id);
    if (onSelectJob) {
      onSelectJob(id);
    }
  };

  // ÂΩìÈÄâÊã©ÁöÑ‰ªªÂä°IDÂèòÊõ¥Êó∂Ë∞ÉÁî®ÂõûË∞É
  useEffect(() => {
    if (selectedJobId && onSelectJob) {
      onSelectJob(selectedJobId);
    }
  }, [selectedJobId, onSelectJob]);

  // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑ‰ªªÂä°
  const selectedJob = useMemo(() => {
    return jobs.find(job => job.id === selectedJobId) || jobs[0];
  }, [jobs, selectedJobId]);

  // Ê†πÊçÆÁ≠õÈÄâÊù°‰ª∂ËøáÊª§ÂíåÊéíÂ∫èÁªìÊûú
  const filteredAndSortedResults = useMemo(() => {
    if (!selectedJob) return [];
    
    console.log(`üîç Â∫îÁî®ËøáÊª§ÂíåÊéíÂ∫è: ËøáÊª§Êù°‰ª∂="${filter}", ÊéíÂ∫èÊñπÂºè="${sortBy} ${sortDirection}", ÂéüÂßãÁªìÊûúÊï∞=${selectedJob.results.length}`);
    
    // È¶ñÂÖàËøáÊª§
    let filtered = selectedJob.results.filter(result => {
      if (filter === "all") return true;
      
      // HTTPÁä∂ÊÄÅÁ†ÅËøáÊª§
      const isHttpSuccess = result.status >= 200 && result.status < 300;
      if (filter === "success") return isHttpSuccess;
      if (filter === "failed") return !isHttpSuccess;
      
      // ÁΩëÁªúÈîôËØØËøáÊª§
      if (filter === "network-errors") return result.isNetworkError === true || result.status === 0;
      
      // ÊµãËØïÁªìÊûúËøáÊª§
      const hasTests = result.testResults && result.testResults.length > 0;
      if (filter === "test-passed") {
        return hasTests && result.testResults!.every(test => test.passed);
      }
      if (filter === "test-failed") {
        return hasTests && !result.testResults!.every(test => test.passed);
      }
      
      return true;
    });
    
    // ÁÑ∂ÂêéÊéíÂ∫è
    filtered.sort((a, b) => {
      let aValue: any, bValue: any;
      
      switch (sortBy) {
        case "response-time":
          aValue = a.responseTime;
          bValue = b.responseTime;
          break;
        case "status-code":
          aValue = a.status;
          bValue = b.status;
          break;
        case "test-results":
          // ÊµãËØïÈÄöËøáÁöÑÊéíÂú®ÂâçÈù¢ÔºåÁÑ∂ÂêéÊåâÈÄöËøáÁöÑÊµãËØïÊï∞ÈáèÊéíÂ∫è
          const aTestsPassed = a.testResults?.filter(t => t.passed).length || 0;
          const bTestsPassed = b.testResults?.filter(t => t.passed).length || 0;
          const aTotalTests = a.testResults?.length || 0;
          const bTotalTests = b.testResults?.length || 0;
          
          // È¶ñÂÖàÊåâÊòØÂê¶ÂÖ®ÈÉ®ÊµãËØïÈÄöËøáÊéíÂ∫è
          const aAllPassed = aTotalTests > 0 && aTestsPassed === aTotalTests;
          const bAllPassed = bTotalTests > 0 && bTestsPassed === bTotalTests;
          
          if (aAllPassed !== bAllPassed) {
            return bAllPassed ? 1 : -1; // ÂÖ®ÈÉ®ÈÄöËøáÁöÑÊéíÂú®ÂâçÈù¢
          }
          
          // ÁÑ∂ÂêéÊåâÈÄöËøáÁéáÊéíÂ∫è
          const aPassRate = aTotalTests > 0 ? aTestsPassed / aTotalTests : 0;
          const bPassRate = bTotalTests > 0 ? bTestsPassed / bTotalTests : 0;
          aValue = aPassRate;
          bValue = bPassRate;
          break;
        case "execution-order":
        default:
          // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºàÊâßË°åÈ°∫Â∫èÔºâ
          aValue = new Date(a.timestamp).getTime();
          bValue = new Date(b.timestamp).getTime();
          break;
      }
      
      // Â§ÑÁêÜÊï∞ÂÄºÊØîËæÉ
      if (typeof aValue === 'number' && typeof bValue === 'number') {
        return sortDirection === "asc" ? aValue - bValue : bValue - aValue;
      }
      
      // Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤ÊØîËæÉ
      const aStr = String(aValue || '');
      const bStr = String(bValue || '');
      const comparison = aStr.localeCompare(bStr);
      return sortDirection === "asc" ? comparison : -comparison;
    });
    
    console.log(`‚úÖ ËøáÊª§ÂíåÊéíÂ∫èÂÆåÊàê: ËøáÊª§Âêé=${filtered.length}‰∏™ÁªìÊûú`, {
      firstResult: filtered[0] ? {
        id: filtered[0].requestId,
        timestamp: filtered[0].timestamp,
        responseTime: filtered[0].responseTime,
        status: filtered[0].status
      } : null,
      lastResult: filtered[filtered.length - 1] ? {
        id: filtered[filtered.length - 1].requestId,
        timestamp: filtered[filtered.length - 1].timestamp,
        responseTime: filtered[filtered.length - 1].responseTime,
        status: filtered[filtered.length - 1].status
      } : null
    });
    
    return filtered;
  }, [selectedJob, filter, sortBy, sortDirection]);

  // Â§ÑÁêÜÊü•ÁúãÁªìÊûúËØ¶ÊÉÖ
  const handleViewResult = (result: ApiResult) => {
    setSelectedResult(result);
    setIsResultDialogOpen(true);
  };

  // ÂØºÂá∫ÁªìÊûú‰∏∫CSV
  const handleExportCsv = () => {
    if (!selectedJob) return;
    
    const headers = ["ÂèÇÊï∞", "Áä∂ÊÄÅÁ†Å", "ÂìçÂ∫îÊó∂Èó¥(ms)", "ÊµãËØïÁªìÊûú", "Êó∂Èó¥Êà≥"];
    const rows = selectedJob.results.map(result => {
      const paramValues = Object.entries(result.parameterValues || {})
        .map(([key, value]) => `${key}=${value}`)
        .join(", ");
      
      const testStatus = result.testResults?.every(test => test.passed)
        ? "ÈÄöËøá"
        : "Â§±Ë¥•";
      
      return [
        paramValues,
        result.status.toString(),
        result.responseTime.toString(),
        testStatus,
        new Date(result.timestamp).toLocaleString()
      ];
    });
    
    const csvContent = [
      headers.join(","),
      ...rows.map(row => row.join(","))
    ].join("\n");
    
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    
    link.setAttribute("href", url);
    link.setAttribute("download", `${selectedJob.name}-results.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="p-4 space-y-4">
      {/* ‰ªªÂä°ÂàóË°® */}
      <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
        {jobs.map((job) => (
          <Card 
            key={job.id}
            className={`cursor-pointer min-w-[200px] ${selectedJobId === job.id ? 'border-primary' : ''}`}
            onClick={() => setSelectedJobId(job.id)}
          >
            <CardHeader className="p-3">
              <CardTitle className="text-sm">{job.name}</CardTitle>
            </CardHeader>
            <CardContent className="p-3 pt-0">
              <div className="flex items-center justify-between text-xs text-gray-500">
                <span>{job.results.length} ‰∏™ÁªìÊûú</span>
                <Badge 
                  variant={job.status === 'completed' ? 'success' : (
                    job.status === 'running' ? 'default' : 'secondary'
                  )}
                >
                  {job.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : (
                    job.status === 'running' ? 'ËøêË°å‰∏≠' : 'Á≠âÂæÖ‰∏≠'
                  )}
                </Badge>
              </div>
              {job.status === 'running' && (
                <Progress value={job.progress} className="h-1 mt-2" />
              )}
            </CardContent>
          </Card>
        ))}
      </div>

      {selectedJob && (
        <Card>
          <CardHeader className="pb-0">
            <div className="flex justify-between items-center">
              <div>
                <CardTitle>{selectedJob.name}</CardTitle>
                <p className="text-sm text-muted-foreground mt-1">
                  ÊòæÁ§∫ {filteredAndSortedResults.length} / {selectedJob.results.length} ‰∏™ÁªìÊûú
                  {filter !== "all" && ` ‚Ä¢ Á≠õÈÄâ: ${
                    filter === "success" ? "HTTPÊàêÂäü" :
                    filter === "failed" ? "HTTPÂ§±Ë¥•" :
                    filter === "network-errors" ? "ÁΩëÁªúÈîôËØØ" :
                    filter === "test-passed" ? "ÊµãËØïÈÄöËøá" :
                    filter === "test-failed" ? "ÊµãËØïÂ§±Ë¥•" : filter
                  }`}
                  {sortBy !== "execution-order" && ` ‚Ä¢ ÊéíÂ∫è: ${
                    sortBy === "response-time" ? "ÂìçÂ∫îÊó∂Èó¥" :
                    sortBy === "status-code" ? "Áä∂ÊÄÅÁ†Å" :
                    sortBy === "test-results" ? "ÊµãËØïÁªìÊûú" : sortBy
                  } ${sortDirection === "asc" ? "ÂçáÂ∫è" : "ÈôçÂ∫è"}`}
                </p>
              </div>
              <div className="flex gap-2">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="outline" size="sm">
                      <Filter className="h-4 w-4 mr-2" />
                      Á≠õÈÄâ
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    <DropdownMenuItem onClick={() => setFilter("all")}>
                      ÂÖ®ÈÉ®ÁªìÊûú
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setFilter("success")}>
                      HTTPÊàêÂäü (2xx)
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setFilter("failed")}>
                      HTTPÂ§±Ë¥• (Èùû2xx)
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setFilter("network-errors")}>
                      ÁΩëÁªúÈîôËØØ
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setFilter("test-passed")}>
                      ÊµãËØïÈÄöËøá
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setFilter("test-failed")}>
                      ÊµãËØïÂ§±Ë¥•
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
                
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button 
                      variant={sortBy !== "execution-order" ? "default" : "outline"} 
                      size="sm"
                      className={sortBy !== "execution-order" ? "bg-blue-600 hover:bg-blue-700 text-white" : ""}
                    >
                      <Filter className="h-4 w-4 mr-2" />
                      ÊéíÂ∫è: {
                        sortBy === "execution-order" ? "ÊâßË°åÈ°∫Â∫è" :
                        sortBy === "response-time" ? "ÂìçÂ∫îÊó∂Èó¥" :
                        sortBy === "status-code" ? "Áä∂ÊÄÅÁ†Å" :
                        "ÊµãËØïÁªìÊûú"
                      } {sortDirection === "asc" ? "üîº" : "üîΩ"}
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    <DropdownMenuItem onClick={() => {setSortBy("execution-order"); setSortDirection("asc");}}>
                      ÊâßË°åÈ°∫Â∫è ‚Üë
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("execution-order"); setSortDirection("desc");}}>
                      ÊâßË°åÈ°∫Â∫è ‚Üì
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("response-time"); setSortDirection("asc");}}>
                      ÂìçÂ∫îÊó∂Èó¥ ‚Üë
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("response-time"); setSortDirection("desc");}}>
                      ÂìçÂ∫îÊó∂Èó¥ ‚Üì
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("status-code"); setSortDirection("asc");}}>
                      Áä∂ÊÄÅÁ†Å ‚Üë
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("status-code"); setSortDirection("desc");}}>
                      Áä∂ÊÄÅÁ†Å ‚Üì
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("test-results"); setSortDirection("desc");}}>
                      ÊµãËØïÈÄöËøáÁéá ‚Üì
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => {setSortBy("test-results"); setSortDirection("asc");}}>
                      ÊµãËØïÈÄöËøáÁéá ‚Üë
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
                
                <Button variant="outline" size="sm" onClick={handleExportCsv}>
                  <Download className="h-4 w-4 mr-2" />
                  ÂØºÂá∫CSV
                </Button>
                
                <Button variant="outline" size="sm">
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Âà∑Êñ∞
                </Button>
              </div>
            </div>
            
            <div className="flex gap-4 text-sm text-gray-500 mt-2">
              <div>ÊÄªËØ∑Ê±Ç: {selectedJob.results.length}</div>
              <div>
                ÂºÄÂßãÊó∂Èó¥: {selectedJob.startTime 
                  ? format(new Date(selectedJob.startTime), "yyyy-MM-dd HH:mm:ss") 
                  : "-"
                }
              </div>
              <div>
                ÁªìÊùüÊó∂Èó¥: {selectedJob.endTime 
                  ? format(new Date(selectedJob.endTime), "yyyy-MM-dd HH:mm:ss") 
                  : "-"
                }
              </div>
              <div>
                ËÄóÊó∂: {selectedJob.startTime && selectedJob.endTime 
                  ? `${Math.round((new Date(selectedJob.endTime).getTime() - new Date(selectedJob.startTime).getTime()) / 1000)}Áßí` 
                  : "-"
                }
              </div>
            </div>
          </CardHeader>
          
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-20">ÊÄª‰ΩìÁä∂ÊÄÅ</TableHead>
                  <TableHead>ÂèÇÊï∞ÂÄº</TableHead>
                  <TableHead className="cursor-pointer hover:bg-gray-50" onClick={() => {
                    if (sortBy === "status-code") {
                      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
                    } else {
                      setSortBy("status-code");
                      setSortDirection("asc");
                    }
                  }}>
                    HTTPÁä∂ÊÄÅ {sortBy === "status-code" && (sortDirection === "asc" ? "üîº" : "üîΩ")}
                  </TableHead>
                  <TableHead className="cursor-pointer hover:bg-gray-50" onClick={() => {
                    if (sortBy === "response-time") {
                      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
                    } else {
                      setSortBy("response-time");
                      setSortDirection("asc");
                    }
                  }}>
                    ÂìçÂ∫îÊó∂Èó¥ {sortBy === "response-time" && (sortDirection === "asc" ? "üîº" : "üîΩ")}
                  </TableHead>
                  <TableHead className="cursor-pointer hover:bg-gray-50" onClick={() => {
                    if (sortBy === "test-results") {
                      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
                    } else {
                      setSortBy("test-results");
                      setSortDirection("desc"); // ÊµãËØïÁªìÊûúÈªòËÆ§ÈôçÂ∫èÔºàÈÄöËøáÁöÑÂú®ÂâçÔºâ
                    }
                  }}>
                    ËÑöÊú¨ÊµãËØï {sortBy === "test-results" && (sortDirection === "asc" ? "üîº" : "üîΩ")}
                  </TableHead>
                  <TableHead className="cursor-pointer hover:bg-gray-50" onClick={() => {
                    if (sortBy === "execution-order") {
                      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
                    } else {
                      setSortBy("execution-order");
                      setSortDirection("asc");
                    }
                  }}>
                    Êó∂Èó¥Êà≥ {sortBy === "execution-order" && (sortDirection === "asc" ? "üîº" : "üîΩ")}
                  </TableHead>
                  <TableHead className="w-20 text-right">Êìç‰Ωú</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredAndSortedResults.map((result: ApiResult, index: number) => {
                  const isPassed = result.testResults?.every((test: any) => test.passed) ?? false;
                  const isHttpSuccess = result.status >= 200 && result.status < 300;
                  const hasTests = result.testResults && result.testResults.length > 0;
                  
                  return (
                    <TableRow key={`${result.requestId}-${index}`}>
                      <TableCell>
                        {isPassed && isHttpSuccess
                          ? <CheckCircle className="h-5 w-5 text-green-500" /> 
                          : <XCircle className="h-5 w-5 text-red-500" />
                        }
                      </TableCell>
                      <TableCell className="font-mono">
                        {Object.entries(result.parameterValues || {}).map(([key, value]) => (
                          <div key={key}>
                            <span className="text-gray-500">{key}:</span> {value}
                          </div>
                        ))}
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center space-x-2">
                          {result.isNetworkError ? (
                            <XCircle className="h-4 w-4 text-orange-500" />
                          ) : isHttpSuccess ? (
                            <CheckCircle className="h-4 w-4 text-green-500" />
                          ) : (
                            <XCircle className="h-4 w-4 text-red-500" />
                          )}
                          <Badge 
                            variant={
                              result.isNetworkError ? "secondary" : 
                              isHttpSuccess ? "default" : "destructive"
                            }
                            className={result.isNetworkError ? "bg-orange-100 text-orange-800 border-orange-300" : ""}
                          >
                            {result.status} {result.statusText}
                          </Badge>
                                                     {result.isNetworkError && (
                             <span className="text-xs text-orange-600" title={result.error || "ÁΩëÁªúËøûÊé•ÈîôËØØ"}>
                               ÁΩëÁªúÈîôËØØ
                             </span>
                           )}
                        </div>
                      </TableCell>
                      <TableCell>{result.responseTime}ms</TableCell>
                      <TableCell>
                        {hasTests ? (
                          <div className="space-y-1">
                            {result.testResults?.map((test: any, i: number) => (
                              <div key={i} className="flex items-center space-x-1">
                                {test.passed 
                                  ? <CheckCircle className="h-3 w-3 text-green-500" /> 
                                  : <XCircle className="h-3 w-3 text-red-500" />
                                }
                                <span className="text-xs truncate max-w-32" title={test.name}>
                                  {test.name}
                                </span>
                                {test.error && (
                                  <span className="text-xs text-red-500 truncate max-w-24" title={test.error}>
                                    ({test.error})
                                  </span>
                                )}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <span className="text-gray-400 text-xs">Êó†ÊµãËØïËÑöÊú¨</span>
                        )}
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center">
                          <Clock className="h-3 w-3 mr-1 text-gray-500" />
                          <span className="text-xs">
                            {format(new Date(result.timestamp), "yyyy-MM-dd HH:mm:ss")}
                          </span>
                        </div>
                      </TableCell>
                      <TableCell className="text-right">
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleViewResult(result)}
                        >
                          <Eye className="h-4 w-4" />
                        </Button>
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </CardContent>
        </Card>
      )}

      {/* ÁªìÊûúËØ¶ÊÉÖÂØπËØùÊ°Ü */}
      <Dialog open={isResultDialogOpen} onOpenChange={setIsResultDialogOpen}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-auto">
          <DialogHeader>
            <DialogTitle>ËØ∑Ê±ÇÁªìÊûúËØ¶ÊÉÖ</DialogTitle>
          </DialogHeader>
          
          {selectedResult && (
            <div className="space-y-4">
              <div className="grid grid-cols-3 gap-4">
                <Card>
                  <CardHeader className="p-3">
                    <CardTitle className="text-sm">ËØ∑Ê±Ç‰ø°ÊÅØ</CardTitle>
                  </CardHeader>
                  <CardContent className="p-3 pt-0">
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="font-medium">Áä∂ÊÄÅÁ†Å:</span> 
                        <Badge 
                          className={`ml-2 ${selectedResult.isNetworkError ? "bg-orange-100 text-orange-800 border-orange-300" : ""}`}
                          variant={selectedResult.isNetworkError ? "secondary" : "default"}
                        >
                          {selectedResult.status} {selectedResult.statusText}
                        </Badge>
                        {selectedResult.isNetworkError && (
                          <span className="ml-2 text-xs text-orange-600">
                            (ÁΩëÁªúËøûÊé•ÈîôËØØ)
                          </span>
                        )}
                      </div>
                      <div>
                        <span className="font-medium">ÂìçÂ∫îÊó∂Èó¥:</span> 
                        <span className="ml-2">{selectedResult.responseTime}ms</span>
                      </div>
                      <div>
                        <span className="font-medium">ÂìçÂ∫îÂ§ßÂ∞è:</span> 
                        <span className="ml-2">{(selectedResult.responseSize / 1024).toFixed(2)}KB</span>
                      </div>
                      <div>
                        <span className="font-medium">Êó∂Èó¥Êà≥:</span> 
                        <span className="ml-2">
                          {format(new Date(selectedResult.timestamp), "yyyy-MM-dd HH:mm:ss")}
                        </span>
                      </div>
                    </div>
                  </CardContent>
                </Card>
                
                <Card>
                  <CardHeader className="p-3">
                    <CardTitle className="text-sm">ÂèÇÊï∞ÂÄº</CardTitle>
                  </CardHeader>
                  <CardContent className="p-3 pt-0">
                    <div className="space-y-2 text-sm">
                      {Object.entries(selectedResult.parameterValues || {}).map(([key, value]) => (
                        <div key={key}>
                          <span className="font-medium">{key}:</span> 
                          <span className="ml-2 font-mono">{value}</span>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
                
                <Card>
                  <CardHeader className="p-3">
                    <CardTitle className="text-sm">ÊµãËØïÁªìÊûú</CardTitle>
                  </CardHeader>
                  <CardContent className="p-3 pt-0">
                    <div className="space-y-2 text-sm">
                      {selectedResult.testResults?.map((test, index) => (
                        <div key={index} className="flex items-start">
                          {test.passed 
                            ? <CheckCircle className="h-4 w-4 text-green-500 mr-2 mt-0.5" /> 
                            : <XCircle className="h-4 w-4 text-red-500 mr-2 mt-0.5" />
                          }
                          <div>
                            <div className="font-medium">{test.name}</div>
                            {test.error && (
                              <div className="text-red-500 text-xs mt-1">{test.error}</div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              </div>
              
              <Card>
                <CardHeader className="p-3">
                  <CardTitle className="text-sm">ÂìçÂ∫îÂ§¥</CardTitle>
                </CardHeader>
                <CardContent className="p-3 pt-0">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    {Object.entries(selectedResult.responseHeaders).map(([key, value]) => (
                      <div key={key}>
                        <span className="font-medium">{key}:</span> 
                        <span className="ml-2 font-mono truncate">{value}</span>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
              
              <Card>
                <CardHeader className="p-3">
                  <CardTitle className="text-sm">ÂìçÂ∫î‰Ωì</CardTitle>
                </CardHeader>
                <CardContent className="p-3 pt-0">
                  <pre className="bg-gray-100 dark:bg-gray-800 p-4 rounded text-xs font-mono whitespace-pre-wrap overflow-auto max-h-96">
                    {selectedResult.responseBody}
                  </pre>
                </CardContent>
              </Card>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
